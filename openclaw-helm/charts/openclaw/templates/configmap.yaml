apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "openclaw.configmapName" . }}
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
data:
  openclaw.json: |
    {{- $config := dict }}
    {{- /* Build agents.defaults section */ -}}
    {{- $agentDefaults := dict }}
    {{- if .Values.openclaw.agents.defaults.model }}
    {{- $_ := set $agentDefaults "model" (dict "primary" .Values.openclaw.agents.defaults.model) }}
    {{- end }}
    {{- if .Values.openclaw.agents.defaults.timeoutSeconds }}
    {{- $_ := set $agentDefaults "timeoutSeconds" .Values.openclaw.agents.defaults.timeoutSeconds }}
    {{- end }}
    {{- if .Values.openclaw.agents.defaults.thinkingDefault }}
    {{- $_ := set $agentDefaults "thinkingDefault" .Values.openclaw.agents.defaults.thinkingDefault }}
    {{- end }}
    {{- if $agentDefaults }}
    {{- $_ := set $config "agents" (dict "defaults" $agentDefaults) }}
    {{- end }}
    {{- /* Add browser CDP config if chromium sidecar is enabled */ -}}
    {{- if .Values.chromium.enabled }}
    {{- $_ := set $config "browser" (dict "cdpUrl" "http://localhost:9222") }}
    {{- end }}
    {{- /* Set gateway mode; when behind gateway-nginx, trust proxy CIDRs and allow token-only auth so Control UI gets full scopes (no device pairing / api.responses.write) */ -}}
    {{- $gateway := dict "mode" "local" }}
    {{- if and .Values.gatewayOauth2Nginx.enabled .Values.gatewayOauth2Nginx.trustedProxiesCidrs }}
    {{- $_ := set $gateway "trustedProxies" .Values.gatewayOauth2Nginx.trustedProxiesCidrs }}
    {{- end }}
    {{- if .Values.gatewayOauth2Nginx.enabled }}
    {{- $_ := set $gateway "controlUi" (dict "allowInsecureAuth" true) }}
    {{- end }}
    {{- $_ := set $config "gateway" $gateway }}
    {{- /* Merge any user-provided overrides */ -}}
    {{- if .Values.openclaw.configOverrides }}
    {{- $config = mergeOverwrite $config .Values.openclaw.configOverrides }}
    {{- end }}
    {{- $config | toPrettyJson | nindent 4 }}
